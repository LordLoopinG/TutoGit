<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <meta charset="UTF-8">
    <title>Seb Social Network</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>

    <style>
        .overlay {
            position: absolute;
            display: none;
            width: 100%;
            background-color: rgba(255, 187, 0, 0.85);
            padding-top: 5%;
            padding-bottom: 5%;
            text-align: center;
        }

        .img-full{
            height: 100%;
        }

        .closeMe{
            position: absolute;
            mix-blend-mode: difference;
            filter: invert(1);
            font-size: 25px;
            font-weight: bold;
            left: 73%;
            top: 10%;
            cursor: pointer;
        }
    </style>

</head>
<body class="bg-light">

    <div class="overlay" id="newPost">
        <br><br>
        <p id="newPostUser">user</p>
        <input type="text" class="w-50 m-1" placeholder="Exprime toi" id="textNewPost">
        <input type="button" class="btn-info m-1" value="OK" id="btnTextOk"><br>
        <input type="text" class="w-50 m-1" placeholder="url de ton image" id="urlNewPost">
        <input type="button" class="btn-info m-1" value="OK" id="btnUrlOk"><br>
        <div class="m-auto w-50">
            <img src="" class="w-100" alt="" id="imgNewPost">
        </div>
        <input type="button" class="btn-info m-1" value="Post !" id="validPost">
        <div class="closeMe">X</div>
    </div>

    <div class="row m-0"  style="display: none" id="divLogin" >
        <form class="m-auto p-3 bg-secondary" id="formLogin">
            <div><img class="d-block m-auto" src="src/LogoPiratBlueSmall.png"></div><br>
            <input type="text" class="mb-2 w-100" placeholder="Pseudo" id="pseudo"><br>
            <input type="password" class="mb-2 w-100" placeholder="Mot de passe" id="MdP"><br>
            <input type="submit" class="btn-danger w-100 mb-2" value="Connexion"><br><br>
            <input type="button" class="btn-info w-100 mb-2" value="Nouvel utilisateur" id="newUser">   
        </form>
    </div>
    
    <div class="col-2 m-2 p-2 bg-secondary w-25 h-25" id="container">
        <p id="divProfil">Zlatan</p>
        <input type="button" class="btn-info w-100" value="Nouveau post" id="btnNewPost">
    </div>

       

<script>
$(document).ready(function () {

/*JSON 1 User

var allUsers = {
    user : [{idUser : 1,
            pseudo : "zlatan",
            mdp : "123456"
            },
            {idUser : 2,
            pseudo : "marco",
            mpd : "654321"}]
}

//JSON 2 Post

var allPosts = {
    post : [{idPost : 1,
            idAuteur : 1,                    // =idUser
            date : "21/01/2021",
            url : "url de l'image",          //verif a faire lors de la soumission, au moins url ou text (sinon post vide!)
            text : "ceci est mon 1er post",
            likes : [1,3,...,7],             //correspond a l'idUser qui a like
            coms : [{idUser : 2,
                    dateCom : "21/01/2021",
                    contenuCom : "J'adore ton post"}]
    }]
}
*/

//Declaration des variables

    //recup de JSON USERS
    var monJsonUsers
    if (!localStorage.getItem("localUsers")) {
        monJsonUsers = {"jsonUsers" : []}
    }else{
        monJsonUsers = JSON.parse(localStorage.getItem("localUsers"))
    }

    //recup de JSON POSTS
    var monJsonPosts
    if (!localStorage.getItem("localPosts")) {
        monJsonPosts = {"jsonPosts" : []}
    }else{
        monJsonPosts = JSON.parse(localStorage.getItem("localPosts"))
    }

// Fonction Inscription

    $("#newUser").click(function () {
        $("#divLogin").html(`
        <form class="m-auto p-3 bg-secondary" id="formInscription">
            <div><img class="d-block m-auto" src="src/LogoPiratBlueSmall.png" id="btnHome"></div><br>
            <input type="text" class="mb-2" placeholder="Pseudo" id="newPseudo"><br>
            <input type="password" placeholder="Mot de passe" id="newMdP"><br>
            <input type="password" placeholder="Verif Mot de passe" id="newMdP2"><br><br>
            <input type="submit" class="btn-danger w-100" value="Inscription">
        </form>
        `)

        //verifications

        $("#formInscription").submit(function(event) {
            event.preventDefault();
            if ( $("#newPseudo").val() == "" || $("#newMdP").val() == "" || $("#newMdP2").val() == "") {    //verif que tous les champs sont remplis
                alert("Merci de completer tous les champs")
            }else{            
                //verif pseudo dispo
                if (monJsonUsers.jsonUsers.length == 0) {
                    //on va créer l'user directement puisque il y'en a aucun donc pas besoin de verif particuliere a part le mot de passe et la confirmation
                    if ( $("#newMdP").val() != $("#newMdP2").val()) {                                       //verif que les 2 MdP sont identiques
                            alert("Mot de passe incorrecte")
                        }else{
                            alert("Inscription terminée. Bienvenu sur meilleur réseau social anomyne. Petit rappel : c'est pas parce c'est anomyme que c'est freestyle, vous êtes responsable de vos publications")
                            newId = 1
                            objNewUser = {"id" : newId , "pseudo" : $("#newPseudo").val(), "MdP" : $("#newMdP").val()}
                            monJsonUsers.jsonUsers.push(objNewUser)
                            localStorage.setItem("localUsers", JSON.stringify(monJsonUsers))
                            $("#divLogin").html(`<div class="m-auto " id="videoIntro"><video class="modal-fullscreen" id="videoIntro" autoplay>
                            <source src="src/LogoAnim.mp4" type="video/mp4">
                            </video></div>`)
                        }
                }else{
                    //on va créer l'user APRES Verification
                    let x
                    for(x in monJsonUsers.jsonUsers) {
                        if ( $("#newPseudo").val() == monJsonUsers.jsonUsers[x].pseudo) {
                            alert("Pseudo déja existant, prends-en un autre !")
                        }else if ( $("#newMdP").val() != $("#newMdP2").val()) {                                       //verif que les 2 MdP sont identiques
                            alert("Mot de passe incorrecte")
                        }else{
                            alert("Inscription terminée. Bienvenu sur meilleur réseau social anomyne. Petit rappel : c'est pas parce c'est anomyme que c'est freestyle, vous êtes responsable de vos publications")
                            newId = monJsonUsers.jsonUsers[monJsonUsers.jsonUsers.length -1].id +1
                            objNewUser = {"id" : newId , "pseudo" : $("#newPseudo").val(), "MdP" : $("#newMdP").val()}
                            monJsonUsers.jsonUsers.push(objNewUser)
                            localStorage.setItem("localUsers", JSON.stringify(monJsonUsers))
                            $("#divLogin").html(`<div class="m-auto" id="videoIntro"><video class="modal-fullscreen" autoplay>
                            <source src="src/LogoAnim.mp4" type="video/mp4">
                            </video></div>`)
                            
                        }
                    }
                }
            }
        })
    })
                
//Fonction LOGIN  

    $("#formLogin").submit(function(event) {
        event.preventDefault
        if ( $("#pseudo").val() == "" || $("#MdP").val() == "") {
            alert("Rempli les 2 champs d'identification, bouffon(e) !")
        }else{
            let X
            for(x in monJsonUsers.jsonUsers) {
                let monUser = monJsonUsers.jsonUsers[x]
                if ( $("#pseudo").val() == monUser.pseudo ) {
                    if (($("#MdP").val() == monUser.MdP)) {
                    alert("Content de te revoir " + monUser.pseudo)
                    $("#divLogin").hide()
                    $("#container").show()
                    $("#divProfil").html(monUser.pseudo)
                    }else{alert("Mauvaise identification, essaye encore")}
                }
            }   
        }         
    })


//MODE RESEAU SOCIAL

    $("#videoIntro").click(function() {
            $("#videoIntro").hide()
    })

    var user = $("#divProfil").val()

    //Nouveau post
    $("#btnNewPost").click(function() {
            $(".overlay").show()
            $("#container").hide()
            $("#newPostUser").text(user)
    })

    $(".closeMe").click(function () {
            $(".overlay").hide()
            $("#container").show()
    })

 
    $("#btnUrlOk").click(function() {
            $("#imgNewPost").attr("src", $("#urlNewPost").val())
    })

    $("#validPost").click(function() {
            let textNewPost = $("#textNewPost").val()
            let urlNewPost = $("#urlNewPost").val()
           // let date = new Date()                   // Attention, faire des manip sur le format
            
            if (textNewPost == "" && urlNewPost == "") {
                alert("Tu postes du vide !!! Recommences")
            }

            if (monJsonPosts.jsonPosts.length == 0) {
                var idPost = 1
            }else{
                var idPost = monJsonPosts.jsonPosts[monJsonPosts.jsonPosts.length -1].id + 1
            }

            var objNewPost = {"idPost" : idPost, "idAuteur" : user, "url" : urlNewPost, "text" : textNewPost, "likes" : [], "com" : []} // Manque Date
            monJsonPosts.jsonPosts.push(objNewPost)
            localStorage.setItem("localPosts", JSON.stringify(monJsonPosts))
    })


})
    
</script>
</body>
</html>